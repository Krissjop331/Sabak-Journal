{% extends "base.html" %}

{% block title %}–°–æ–∑–¥–∞—Ç—å —É—Ä–æ–∫ –∏–∑ —Ä–∞—Å–ø–∏—Å–∞–Ω–∏—è{% endblock %}

{% block content %}
<div class="container mx-auto px-4 py-8">
    <div class="max-w-2xl mx-auto">
        <!-- –ó–∞–≥–æ–ª–æ–≤–æ–∫ -->
        <div class="flex items-center justify-between mb-8">
            <div>
                <h1 class="text-3xl font-bold text-gray-800 mb-2">üìö –°–æ–∑–¥–∞—Ç—å —É—Ä–æ–∫</h1>
                <p class="text-gray-600">–°–æ–∑–¥–∞–Ω–∏–µ —É—Ä–æ–∫–∞ –∏–∑ —Ä–∞—Å–ø–∏—Å–∞–Ω–∏—è</p>
            </div>
            <a href="{% url 'schedule' %}" class="bg-gray-500 hover:bg-gray-600 text-white font-bold py-2 px-4 rounded">
                ‚Üê –ù–∞–∑–∞–¥
            </a>
        </div>

        <!-- –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ —Ä–∞—Å–ø–∏—Å–∞–Ω–∏–∏ -->
        <div class="bg-blue-50 border border-blue-200 rounded-lg p-6 mb-6">
            <h3 class="font-bold text-blue-800 mb-4">üìÖ –í—ã–±—Ä–∞–Ω–Ω–æ–µ –∑–∞–Ω—è—Ç–∏–µ –∏–∑ —Ä–∞—Å–ø–∏—Å–∞–Ω–∏—è</h3>

            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                <div>
                    <h4 class="font-medium text-blue-700 mb-2">–û—Å–Ω–æ–≤–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è</h4>
                    <div class="space-y-1 text-sm text-blue-600">
                        <p><strong>–ü—Ä–µ–¥–º–µ—Ç:</strong> {{ schedule.subject.name }}</p>
                        <p><strong>–ì—Ä—É–ø–ø–∞:</strong> {{ schedule.group.name }}</p>
                        <p><strong>–ü—Ä–µ–ø–æ–¥–∞–≤–∞—Ç–µ–ª—å:</strong> {{ schedule.teacher.user.get_full_name }}</p>
                        <p><strong>–î–µ–Ω—å –Ω–µ–¥–µ–ª–∏:</strong> {{ schedule.get_weekday_display }}</p>
                    </div>
                </div>

                <div>
                    <h4 class="font-medium text-blue-700 mb-2">–í—Ä–µ–º—è –∏ –º–µ—Å—Ç–æ</h4>
                    <div class="space-y-1 text-sm text-blue-600">
                        <p><strong>–í—Ä–µ–º—è:</strong> {{ schedule.get_time_range }}</p>
                        <p><strong>–ê—É–¥–∏—Ç–æ—Ä–∏—è:</strong> {{ schedule.classroom|default:"–ù–µ —É–∫–∞–∑–∞–Ω–∞" }}</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- –§–æ—Ä–º–∞ —Å–æ–∑–¥–∞–Ω–∏—è —É—Ä–æ–∫–∞ -->
        <div class="bg-white rounded-lg shadow-lg p-6">
            <form method="post" class="space-y-6">
                {% csrf_token %}

                <!-- –î–∞—Ç–∞ —É—Ä–æ–∫–∞ -->
                <div>
                    <label for="date" class="block text-sm font-medium text-gray-700 mb-2">
                        –î–∞—Ç–∞ —É—Ä–æ–∫–∞ <span class="text-red-500">*</span>
                    </label>
                    <input type="date" name="date" id="date" required
                           min="{{ today|date:'Y-m-d' }}"
                           class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                    <p class="text-xs text-gray-500 mt-1">
                        –í—ã–±–µ—Ä–∏—Ç–µ –¥–∞—Ç—É, –∫–æ—Ç–æ—Ä–∞—è –ø—Ä–∏—Ö–æ–¥–∏—Ç—Å—è –Ω–∞ {{ schedule.get_weekday_display|lower }}
                    </p>
                </div>

                <!-- –ê—É–¥–∏—Ç–æ—Ä–∏—è (–ø–µ—Ä–µ–æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ) -->
                <div>
                    <label for="classroom" class="block text-sm font-medium text-gray-700 mb-2">
                        –ê—É–¥–∏—Ç–æ—Ä–∏—è
                    </label>
                    <input type="text" name="classroom" id="classroom"
                           value="{{ schedule.classroom|default:'' }}"
                           placeholder="–û—Å—Ç–∞–≤—å—Ç–µ –ø—É—Å—Ç—ã–º –¥–ª—è –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è –∏–∑ —Ä–∞—Å–ø–∏—Å–∞–Ω–∏—è"
                           class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                    <p class="text-xs text-gray-500 mt-1">
                        –ü–æ —É–º–æ–ª—á–∞–Ω–∏—é: {{ schedule.classroom|default:"–Ω–µ —É–∫–∞–∑–∞–Ω–∞" }}
                    </p>
                </div>

                <!-- –ó–∞–º–µ—Ç–∫–∏ -->
                <div>
                    <label for="notes" class="block text-sm font-medium text-gray-700 mb-2">
                        –ó–∞–º–µ—Ç–∫–∏ –∫ —É—Ä–æ–∫—É
                    </label>
                    <textarea name="notes" id="notes" rows="3"
                              placeholder="–î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–º —É—Ä–æ–∫–µ..."
                              class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500"></textarea>
                </div>

                <!-- –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏–æ–Ω–Ω—ã–π –±–ª–æ–∫ -->
                <div class="bg-gray-50 border border-gray-200 rounded-lg p-4">
                    <h4 class="font-medium text-gray-800 mb-2">‚ÑπÔ∏è –ß—Ç–æ –ø—Ä–æ–∏–∑–æ–π–¥–µ—Ç –ø—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏</h4>
                    <ul class="text-sm text-gray-600 space-y-1">
                        <li>‚Ä¢ –£—Ä–æ–∫ –±—É–¥–µ—Ç —Å–æ–∑–¥–∞–Ω —Å –≤—Ä–µ–º–µ–Ω–µ–º: <strong>{{ schedule.get_time_range }}</strong></li>
                        <li>‚Ä¢ –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —Å–æ–∑–¥–∞—Å—Ç—Å—è –ø–æ—Å–µ—â–∞–µ–º–æ—Å—Ç—å –¥–ª—è –≤—Å–µ—Ö —Å—Ç—É–¥–µ–Ω—Ç–æ–≤ –≥—Ä—É–ø–ø—ã <strong>{{ schedule.group.name }}</strong></li>
                        <li>‚Ä¢ –£—Ä–æ–∫ –±—É–¥–µ—Ç —Å–≤—è–∑–∞–Ω —Å —ç—Ç–∏–º —Ä–∞—Å–ø–∏—Å–∞–Ω–∏–µ–º</li>
                        <li>‚Ä¢ –í—ã —Å–º–æ–∂–µ—Ç–µ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å –ø–æ—Å–µ—â–∞–µ–º–æ—Å—Ç—å –∏ –≤—ã—Å—Ç–∞–≤–ª—è—Ç—å –æ—Ü–µ–Ω–∫–∏</li>
                    </ul>
                </div>

                <!-- –ö–Ω–æ–ø–∫–∏ -->
                <div class="flex justify-between items-center pt-4">
                    <a href="{% url 'schedule' %}"
                       class="bg-gray-300 hover:bg-gray-400 text-gray-800 font-bold py-2 px-4 rounded transition duration-200">
                        –û—Ç–º–µ–Ω–∞
                    </a>
                    <button type="submit"
                            class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-6 rounded-lg transition duration-200">
                        ‚úÖ –°–æ–∑–¥–∞—Ç—å —É—Ä–æ–∫
                    </button>
                </div>
            </form>
        </div>

        <!-- –ö–∞–ª–µ–Ω–¥–∞—Ä—å-–ø–æ–¥—Å–∫–∞–∑–∫–∞ -->
        <div class="mt-6 bg-yellow-50 border border-yellow-200 rounded-lg p-4">
            <h4 class="font-medium text-yellow-800 mb-2">üìÖ –ü–æ–¥—Å–∫–∞–∑–∫–∞ –ø–æ –¥–Ω—è–º</h4>
            <p class="text-sm text-yellow-700">
                –í—ã–±—Ä–∞–Ω–Ω–æ–µ —Ä–∞—Å–ø–∏—Å–∞–Ω–∏–µ –¥–µ–π—Å—Ç–≤—É–µ—Ç –ø–æ <strong>{{ schedule.get_weekday_display|lower }}–∞–º</strong>.
                –£–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ –≤—ã–±—Ä–∞–Ω–Ω–∞—è –¥–∞—Ç–∞ –ø—Ä–∏—Ö–æ–¥–∏—Ç—Å—è –∏–º–µ–Ω–Ω–æ –Ω–∞ —ç—Ç–æ—Ç –¥–µ–Ω—å –Ω–µ–¥–µ–ª–∏.
            </p>
        </div>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const dateInput = document.getElementById('date');
    const scheduleWeekday = {{ schedule.weekday }};

    // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ –¥–Ω—è –Ω–µ–¥–µ–ª–∏
    function checkWeekday() {
        if (dateInput.value) {
            const selectedDate = new Date(dateInput.value);
            const selectedWeekday = (selectedDate.getDay() + 6) % 7; // –ö–æ–Ω–≤–µ—Ä—Ç–∏—Ä—É–µ–º –≤ Python —Ñ–æ—Ä–º–∞—Ç

            const messageDiv = document.getElementById('weekday-message');
            if (messageDiv) {
                messageDiv.remove();
            }

            if (selectedWeekday !== scheduleWeekday) {
                const weekdayNames = ['–ø–æ–Ω–µ–¥–µ–ª—å–Ω–∏–∫', '–≤—Ç–æ—Ä–Ω–∏–∫', '—Å—Ä–µ–¥—É', '—á–µ—Ç–≤–µ—Ä–≥', '–ø—è—Ç–Ω–∏—Ü—É', '—Å—É–±–±–æ—Ç—É', '–≤–æ—Å–∫—Ä–µ—Å–µ–Ω—å–µ'];
                const scheduleWeekdayName = weekdayNames[scheduleWeekday];
                const selectedWeekdayName = weekdayNames[selectedWeekday];

                const warningDiv = document.createElement('div');
                warningDiv.id = 'weekday-message';
                warningDiv.className = 'mt-2 p-3 bg-red-50 border border-red-200 rounded-md';
                warningDiv.innerHTML = `
                    <div class="flex">
                        <svg class="h-5 w-5 text-red-400 mr-2" fill="currentColor" viewBox="0 0 20 20">
                            <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM8.707 7.293a1 1 0 00-1.414 1.414L8.586 10l-1.293 1.293a1 1 0 101.414 1.414L10 11.414l1.293 1.293a1 1 0 001.414-1.414L11.414 10l1.293-1.293a1 1 0 00-1.414-1.414L10 8.586 8.707 7.293z" clip-rule="evenodd"></path>
                        </svg>
                        <div class="text-sm text-red-700">
                            <strong>–í–Ω–∏–º–∞–Ω–∏–µ!</strong> –í—ã–±—Ä–∞–Ω–Ω–∞—è –¥–∞—Ç–∞ –ø—Ä–∏—Ö–æ–¥–∏—Ç—Å—è –Ω–∞ ${selectedWeekdayName},
                            –∞ —Ä–∞—Å–ø–∏—Å–∞–Ω–∏–µ –¥–µ–π—Å—Ç–≤—É–µ—Ç –ø–æ ${scheduleWeekdayName}–∞–º. –í—ã–±–µ—Ä–∏—Ç–µ –ø—Ä–∞–≤–∏–ª—å–Ω—É—é –¥–∞—Ç—É.
                        </div>
                    </div>
                `;
                dateInput.parentNode.appendChild(warningDiv);
            }
        }
    }

    // –ü—Ä–æ–≤–µ—Ä—è–µ–º –ø—Ä–∏ –∏–∑–º–µ–Ω–µ–Ω–∏–∏ –¥–∞—Ç—ã
    dateInput.addEventListener('change', checkWeekday);

    // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –±–ª–∏–∂–∞–π—à—É—é –ø–æ–¥—Ö–æ–¥—è—â—É—é –¥–∞—Ç—É
    function setNearestValidDate() {
        const today = new Date();
        const todayWeekday = (today.getDay() + 6) % 7;

        let daysToAdd = scheduleWeekday - todayWeekday;
        if (daysToAdd < 0) {
            daysToAdd += 7; // –°–ª–µ–¥—É—é—â–∞—è –Ω–µ–¥–µ–ª—è
        }
        if (daysToAdd === 0 && today.getHours() > 18) {
            daysToAdd = 7; // –ï—Å–ª–∏ —É–∂–µ –ø–æ–∑–¥–Ω–æ —Å–µ–≥–æ–¥–Ω—è, –±–µ—Ä–µ–º —Å–ª–µ–¥—É—é—â—É—é –Ω–µ–¥–µ–ª—é
        }

        const targetDate = new Date(today);
        targetDate.setDate(today.getDate() + daysToAdd);

        dateInput.value = targetDate.toISOString().split('T')[0];
    }

    // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –ø–æ–¥—Ö–æ–¥—è—â—É—é –¥–∞—Ç—É –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ
    setNearestValidDate();
});

// –í–∞–ª–∏–¥–∞—Ü–∏—è —Ñ–æ—Ä–º—ã
document.querySelector('form').addEventListener('submit', function(e) {
    const dateInput = document.getElementById('date');

    if (!dateInput.value) {
        e.preventDefault();
        alert('–í—ã–±–µ—Ä–∏—Ç–µ –¥–∞—Ç—É —É—Ä–æ–∫–∞');
        return false;
    }

    const selectedDate = new Date(dateInput.value);
    const selectedWeekday = (selectedDate.getDay() + 6) % 7;

    if (selectedWeekday !== {{ schedule.weekday }}) {
        e.preventDefault();
        alert('–í—ã–±—Ä–∞–Ω–Ω–∞—è –¥–∞—Ç–∞ –Ω–µ —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É–µ—Ç –¥–Ω—é –Ω–µ–¥–µ–ª–∏ —Ä–∞—Å–ø–∏—Å–∞–Ω–∏—è');
        return false;
    }

    return true;
});
</script>

<style>
.container {
    animation: fadeIn 0.5s ease-in;
}

@keyframes fadeIn {
    from { opacity: 0; transform: translateY(20px); }
    to { opacity: 1; transform: translateY(0); }
}
</style>
{% endblock %}
